<mat-toolbar color="primary">
  <span>{{ auth.clientLabel() }}</span>
</mat-toolbar>

<mat-divider></mat-divider>

<div class="main-container">
  @if (auth.isAuthenticated()) {
    <mat-card>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button mat-raised-button color="warn" (click)="logout()">
          <mat-icon fontSet="material-icons">logout</mat-icon>
          Logout
        </button>

        <button mat-raised-button color="accent" (click)="mostrarAccessToken()">
          <mat-icon fontSet="material-icons">visibility</mat-icon>
          Ver Access Token > consola
        </button>

        <button mat-raised-button color="primary" (click)="goUserProfile()">
          <mat-icon fontSet="material-icons">person</mat-icon>
          Perfil de usuario
        </button>

        <button mat-raised-button color="primary" (click)="refreshSession()" [disabled]="auth.refreshing()">
          <mat-icon fontSet="material-icons" [class.spin]="auth.refreshing()">
            autorenew
          </mat-icon>
          {{ auth.refreshing() ? 'Refreshing…' : 'Refresh session' }}
        </button>
      </div>

      <mat-card appearance="outlined" style="margin-top: 24px; padding: 16px;">
        <h3 style="margin-top: 0; margin-bottom: 16px;">Panel de pruebas de Redirección</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
          
          <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
            <button mat-raised-button color="primary" (click)="goUrlConDeepLink()" style="width: 100%; height: 48px; font-size: 1.1em;">
              <mat-icon fontSet="material-icons">check_circle</mat-icon>
              URL con Deep Link Válido
            </button>
            <div style="font-size: 0.85em; color: #666; margin-left: 4px; word-break: break-all;">
              <strong>Destino:</strong> {{urlConDeepLink}}
            </div>
          </div>

          <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
            <button mat-raised-button (click)="goUrlConDeepLinkInvalido()" style="width: 100%; height: 48px; font-size: 1.1em; background-color: #fb8c00; color: white;">
              <mat-icon fontSet="material-icons">error</mat-icon>
              URL con Deep Link Inválido
            </button>
            <div style="font-size: 0.85em; color: #666; margin-left: 4px; word-break: break-all;">
              <strong>Destino:</strong> {{urlConDeepLinkInvalido}}
            </div>
          </div>

          <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
            <button mat-raised-button color="accent" (click)="goUrlSinDeepLink()" style="width: 100%; height: 48px; font-size: 1.1em;">
              <mat-icon fontSet="material-icons">link</mat-icon>
              URL sin Deep Link
            </button>
            <div style="font-size: 0.85em; color: #666; margin-left: 4px; word-break: break-all;">
              <strong>Destino:</strong> {{urlSinDeepLink}}
            </div>
          </div>

          <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
            <button mat-raised-button color="primary" (click)="goUrlSbMasPagosConDeepLink()" style="width: 100%; height: 48px; font-size: 1.1em;">
              <mat-icon fontSet="material-icons">payments</mat-icon>
              URL MasPagos con Deep Link
            </button>
            <div style="font-size: 0.85em; color: #666; margin-left: 4px; word-break: break-all;">
              <strong>Destino:</strong> {{urlSbMasPagosConDeepLink}}
            </div>
          </div>

        </div>
      </mat-card>

      <br />
      <p>Is Authenticated:<strong> {{ auth }}</strong></p>
    </mat-card>
  } @else {
    <mat-card>
      <button mat-raised-button class="btn-success" (click)="login()">
        <mat-icon fontSet="material-icons">login</mat-icon>
        Iniciar sesion
      </button>
    </mat-card>
  }

  <mat-divider></mat-divider>
  <br />

  <mat-expansion-panel>
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon fontSet="material-icons">settings</mat-icon>
        Configuration loaded
      </mat-panel-title>
    </mat-expansion-panel-header>
    <pre>{{ auth.config() | json }}</pre>
  </mat-expansion-panel>

  <br />

  <mat-expansion-panel class="panel-info" (opened)="loadAccessTokenPayload()">
    @let atp = auth.accessPayload();

    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon fontSet="material-icons">vpn_key</mat-icon>
        Access Token (decoded)
      </mat-panel-title>
      <mat-panel-description>
        @if (atp) { exp: {{ (atp.exp * 1000) | date:'medium' }} } @else { &nbsp; }
      </mat-panel-description>
    </mat-expansion-panel-header>

    @if (atp) {
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <button mat-stroked-button (click)="copy(auth.accessToken())" [disabled]="!auth.accessToken()">
          <mat-icon fontSet="material-icons">content_copy</mat-icon>
          Copiar JWT
        </button>
        <button mat-stroked-button (click)="copyJson(atp)">
          <mat-icon fontSet="material-icons">content_copy</mat-icon>
          Copiar payload
        </button>
      </div>
      <pre>{{ atp | json }}</pre>
    } @else {
      <p style="opacity:.7">Abrí el panel (y logueate) para cargar el payload del access token.</p>
    }
  </mat-expansion-panel>

  <br />

  <mat-expansion-panel class="panel-info" (opened)="loadIdTokenPayload()">
    @let pid = auth.idPayload();

    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon fontSet="material-icons">verified_user</mat-icon>
        ID Token (decoded)
      </mat-panel-title>
      <mat-panel-description>
        @if (pid) { exp: {{ (pid.exp * 1000) | date:'medium' }} } @else { &nbsp; }
      </mat-panel-description>
    </mat-expansion-panel-header>

    @if (pid) {
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <button mat-stroked-button (click)="copy(auth.idToken())" [disabled]="!auth.idToken()">
          <mat-icon fontSet="material-icons">content_copy</mat-icon>
          Copiar JWT
        </button>
        <button mat-stroked-button (click)="copyJson(pid)">
          <mat-icon fontSet="material-icons">content_copy</mat-icon>
          Copiar payload
        </button>
      </div>
      <pre>{{ pid | json }}</pre>
    } @else {
      <p style="opacity:.7">Abrí el panel (y logueate) para cargar el payload del ID token.</p>
    }
  </mat-expansion-panel>

  <br />

  <mat-expansion-panel class="panel-info" (opened)="loadUserInfo()">
    <mat-expansion-panel-header>
      <mat-panel-title class="title-with-icon">
        <mat-icon fontSet="material-icons">badge</mat-icon>
        UserInfo
      </mat-panel-title>
      <mat-panel-description>
        @if (auth.userInfo()) {
          actualizado: {{ auth.userInfoLoadedAt() | date:'mediumTime' }}
        } @else { &nbsp; }
      </mat-panel-description>
    </mat-expansion-panel-header>

    @if (auth.userInfo()) {
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <button mat-stroked-button (click)="refreshUserInfo()">
          <mat-icon fontSet="material-icons">refresh</mat-icon>
          Actualizar
        </button>
        <button mat-stroked-button (click)="copyJson(auth.userInfo())">
          <mat-icon fontSet="material-icons">content_copy</mat-icon>
          Copiar JSON
        </button>
      </div>
      <pre>{{ auth.userInfo() | json }}</pre>
    } @else {
      <p style="opacity:.7">
        Abrí el panel (y logueate) para consultar /connect/userinfo.
      </p>
    }
  </mat-expansion-panel>

  <router-outlet></router-outlet>
</div>